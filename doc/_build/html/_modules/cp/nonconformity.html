<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>cp.nonconformity &mdash; Orange - Conformal Prediction 1.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Orange - Conformal Prediction 1.0 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for cp.nonconformity</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Nonconformity module contains nonconformity scores for classification and regression.</span>

<span class="sd">Structure:</span>

<span class="sd">- ClassNC (classification scores)</span>
<span class="sd">    - ClassModelNC (model based)</span>
<span class="sd">        :py:class:`InverseProbability`, :py:class:`ProbabilityMargin`, :py:class:`SVMDistance`,</span>
<span class="sd">        :py:class:`LOOClassNC`</span>
<span class="sd">    - ClassNearestNeighboursNC (nearest neighbours based)</span>
<span class="sd">        :py:class:`KNNDistance`, :py:class:`KNNFraction`</span>
<span class="sd">- RegrNC (regression scores)</span>
<span class="sd">    - RegrModelNC (model based)</span>
<span class="sd">        :py:class:`AbsError`, :py:class:`AbsErrorRF` :py:class:`AbsErrorNormalized`, :py:class:`LOORegrNC`,</span>
<span class="sd">        :py:class:`ErrorModelNC`</span>
<span class="sd">    - RegrNearestNeighboursNC (nearest neighbours based)</span>
<span class="sd">        :py:class:`AbsErrorKNN`, :py:class:`AvgErrorKNN`</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">Orange.base</span> <span class="kn">import</span> <span class="n">Model</span>


<span class="c1"># ----- CLASSIFICATION ----- #</span>
<span class="kn">from</span> <span class="nn">Orange.data</span> <span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">RowInstance</span><span class="p">,</span> <span class="n">Instance</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="kn">import</span> <span class="n">SVC</span><span class="p">,</span> <span class="n">LinearSVC</span><span class="p">,</span> <span class="n">NuSVC</span>

<span class="kn">from</span> <span class="nn">cp.utils</span> <span class="kn">import</span> <span class="n">get_instance</span>


<div class="viewcode-block" id="ClassNC"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.ClassNC">[docs]</a><span class="k">class</span> <span class="nc">ClassNC</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base class for classification nonconformity scores.</span>

<span class="sd">    Extending classes should implement :py:func:`fit` and :py:func:`nonconformity` methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ClassNC.fit"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.ClassNC.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process the data used for later calculation of nonconformities.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (Table): Data set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="ClassNC.nonconformity"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.ClassNC.nonconformity">[docs]</a>    <span class="k">def</span> <span class="nf">nonconformity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the nonconformity score of the given `instance`.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>


<span class="c1"># --- model-based --- #</span>

<div class="viewcode-block" id="ClassModelNC"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.ClassModelNC">[docs]</a><span class="k">class</span> <span class="nc">ClassModelNC</span><span class="p">(</span><span class="n">ClassNC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for classification nonconformity scores that are based on an underlying classifier.</span>

<span class="sd">    Extending classes should implement :py:func:`ClassNC.nonconformity` method.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        learner: Untrained underlying classifier.</span>
<span class="sd">        model: Trained underlying classifier.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ClassModelNC.__init__"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.ClassModelNC.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Store the provided classifier as :py:attr:`learner`.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learner</span> <span class="o">=</span> <span class="n">classifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">None</span></div>

<div class="viewcode-block" id="ClassModelNC.fit"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.ClassModelNC.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Train the underlying classifier on provided data and store the trained model.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learner</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="InverseProbability"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.InverseProbability">[docs]</a><span class="k">class</span> <span class="nc">InverseProbability</span><span class="p">(</span><span class="n">ClassModelNC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Inverse probability nonconformity score returns :math:`1 - p`, where :math:`p` is the probability</span>
<span class="sd">    assigned to the actual class by the underlying classification model (:py:attr:`ClassModelNC.model`).</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; train, test = next(LOOSampler(Table(&#39;iris&#39;)))</span>
<span class="sd">        &gt;&gt;&gt; tp = TransductiveClassifier(InverseProbability(NaiveBayesLearner()), train)</span>
<span class="sd">        &gt;&gt;&gt; print(tp(test[0].x, 0.1))</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="InverseProbability.nonconformity"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.InverseProbability.nonconformity">[docs]</a>    <span class="k">def</span> <span class="nf">nonconformity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="n">Model</span><span class="o">.</span><span class="n">Probs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">predictions</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">get_class</span><span class="p">())]</span></div></div>


<div class="viewcode-block" id="ProbabilityMargin"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.ProbabilityMargin">[docs]</a><span class="k">class</span> <span class="nc">ProbabilityMargin</span><span class="p">(</span><span class="n">ClassModelNC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Probability margin nonconformity score measures the difference :math:`d_p` between the predicted probability</span>
<span class="sd">    of the actual class and the largest probability corresponding to some other class. To put the values on scale</span>
<span class="sd">    from 0 to 1, the nonconformity function returns :math:`(1 - d_p) / 2`.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; train, test = next(LOOSampler(Table(&#39;iris&#39;)))</span>
<span class="sd">        &gt;&gt;&gt; tp = TransductiveClassifier(ProbabilityMargin(LogisticRegressionLearner()), train)</span>
<span class="sd">        &gt;&gt;&gt; print(tp(test[0].x, 0.1))</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ProbabilityMargin.nonconformity"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.ProbabilityMargin.nonconformity">[docs]</a>    <span class="k">def</span> <span class="nf">nonconformity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="n">Model</span><span class="o">.</span><span class="n">Probs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">get_class</span><span class="p">())</span>
        <span class="n">py</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">y</span><span class="p">]</span>
        <span class="n">pz</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p</span> <span class="k">for</span> <span class="n">z</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span> <span class="k">if</span> <span class="n">z</span> <span class="o">!=</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">py</span> <span class="o">-</span> <span class="n">pz</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span></div></div>


<div class="viewcode-block" id="SVMDistance"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.SVMDistance">[docs]</a><span class="k">class</span> <span class="nc">SVMDistance</span><span class="p">(</span><span class="n">ClassNC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;SVMDistance nonconformity score measures the distance from the SVM&#39;s decision boundary. The score depends</span>
<span class="sd">    on the distance and the side of the decision boundary that the example lies on.</span>
<span class="sd">    Examples that lie on the correct side of the decision boundary and would therefore result in a</span>
<span class="sd">    correct prediction using the SVM classifier have a nonconformity score less than 1, while the incorrectly</span>
<span class="sd">    predicted examples have a score more than 1.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \\mathit{nc} =</span>
<span class="sd">        \\begin{cases}</span>
<span class="sd">        \\frac{1}{1+d} &amp; \\text{correct}\\\\</span>
<span class="sd">        1+d &amp;\\text{incorrect}</span>
<span class="sd">        \\end{cases}</span>

<span class="sd">    The provided SVM classifier must be a sklearn&#39;s SVM classifier (SVC, LinearSVC, NuSVC)</span>
<span class="sd">    providing the decision_function() which computes the distance to decision boundary. This nonconformity works</span>
<span class="sd">    only for binary classification problems.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from sklearn.svm import SVC</span>
<span class="sd">        &gt;&gt;&gt; train, test = next(LOOSampler(Table(&#39;titanic&#39;)))</span>
<span class="sd">        &gt;&gt;&gt; train, calibrate = next(RandomSampler(train, 2, 1))</span>
<span class="sd">        &gt;&gt;&gt; icp = InductiveClassifier(SVMDistance(SVC()), train, calibrate)</span>
<span class="sd">        &gt;&gt;&gt; print(icp(test[0].x, 0.1))</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SVMDistance.__init__"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.SVMDistance.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classifier</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="p">(</span><span class="n">SVC</span><span class="p">,</span> <span class="n">LinearSVC</span><span class="p">,</span> <span class="n">NuSVC</span><span class="p">)),</span> \
            <span class="s2">&quot;Classifier must be a sklearn&#39;s SVM classifier (SVC, LinearSVC, NuSVC).&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clf</span> <span class="o">=</span> <span class="n">classifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">None</span></div>

<div class="viewcode-block" id="SVMDistance.fit"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.SVMDistance.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">class_var</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> \
            <span class="s2">&quot;SVMDistance supports only binary classification problems.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span></div>

<div class="viewcode-block" id="SVMDistance.nonconformity"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.SVMDistance.nonconformity">[docs]</a>    <span class="k">def</span> <span class="nf">nonconformity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">x</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">x</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">y</span> <span class="o">==</span> <span class="n">y</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></div></div>


<span class="c1"># --- knn-based --- #</span>

<div class="viewcode-block" id="NearestNeighbours"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.NearestNeighbours">[docs]</a><span class="k">class</span> <span class="nc">NearestNeighbours</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base class for nonconformity measures based on nearest neighbours.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        distance: Distance measure.</span>
<span class="sd">        k (int):  Number of nearest neighbours.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="NearestNeighbours.__init__"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.NearestNeighbours.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Store the distance measure and the number of neighbours.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distance</span> <span class="o">=</span> <span class="n">distance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span></div>

<div class="viewcode-block" id="NearestNeighbours.fit"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.NearestNeighbours.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Store the data for finding nearest neighbours.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span></div>

<div class="viewcode-block" id="NearestNeighbours.neighbours"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.NearestNeighbours.neighbours">[docs]</a>    <span class="k">def</span> <span class="nf">neighbours</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute distances to all other data instances using the distance measure (:py:attr:`distance`).</span>

<span class="sd">        Excludes data instances that are equal to the provided `instance`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of pairs (distance, instance) in increasing order of distances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">other</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">x</span><span class="p">)]</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">row</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">other</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">([(</span><span class="n">d</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">other</span><span class="p">)],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="ClassNearestNeighboursNC"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.ClassNearestNeighboursNC">[docs]</a><span class="k">class</span> <span class="nc">ClassNearestNeighboursNC</span><span class="p">(</span><span class="n">NearestNeighbours</span><span class="p">,</span> <span class="n">ClassNC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for nearest neighbrours based classification nonconformity scores.&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="KNNDistance"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.KNNDistance">[docs]</a><span class="k">class</span> <span class="nc">KNNDistance</span><span class="p">(</span><span class="n">ClassNearestNeighboursNC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the sum of distances to k nearest neighbours of the same class as the given instance and</span>
<span class="sd">    the sum of distances to k nearest neighbours of other classes. Returns their ratio.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from Orange.distance import Euclidean</span>
<span class="sd">        &gt;&gt;&gt; train, test = next(LOOSampler(Table(&#39;iris&#39;)))</span>
<span class="sd">        &gt;&gt;&gt; cp = CrossClassifier(KNNDistance(Euclidean, 10), 2, train)</span>
<span class="sd">        &gt;&gt;&gt; print(cp(test[0].x, 0.1))</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="KNNDistance.nonconformity"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.KNNDistance.nonconformity">[docs]</a>    <span class="k">def</span> <span class="nf">nonconformity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="n">same</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dist</span> <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">get_class</span><span class="p">()</span> <span class="o">==</span> <span class="n">instance</span><span class="o">.</span><span class="n">get_class</span><span class="p">()]</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dist</span> <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">get_class</span><span class="p">()</span> <span class="o">!=</span> <span class="n">instance</span><span class="o">.</span><span class="n">get_class</span><span class="p">()]</span>
        <span class="n">same</span><span class="p">,</span> <span class="n">diff</span> <span class="o">=</span> <span class="n">same</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">],</span> <span class="n">diff</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">same</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="KNNFraction"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.KNNFraction">[docs]</a><span class="k">class</span> <span class="nc">KNNFraction</span><span class="p">(</span><span class="n">ClassNearestNeighboursNC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the k nearest neighbours of the given instance. Returns the fraction of instances of the</span>
<span class="sd">    same class as the given instance within its k nearest neighbours.</span>

<span class="sd">    Weighted version uses weights :math:`1/d_i` based on distances instead of simply counting the instances.</span>
<span class="sd">    Non-weighted version is equivalent to using a value 1 for all weights.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; train, test = next(LOOSampler(Table(&#39;iris&#39;)))</span>
<span class="sd">        &gt;&gt;&gt; cp = CrossClassifier(KNNFraction(Euclidean, 10, weighted=True), 2, train)</span>
<span class="sd">        &gt;&gt;&gt; print(cp(test[0].x, 0.1))</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="KNNFraction.__init__"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.KNNFraction.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">weighted</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weighted</span> <span class="o">=</span> <span class="n">weighted</span></div>

<div class="viewcode-block" id="KNNFraction.nonconformity"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.KNNFraction.nonconformity">[docs]</a>    <span class="k">def</span> <span class="nf">nonconformity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span><span class="p">(</span><span class="n">instance</span><span class="p">)[:</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weighted</span><span class="p">:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dist</span> <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">get_class</span><span class="p">()</span> <span class="o">!=</span> <span class="n">instance</span><span class="o">.</span><span class="n">get_class</span><span class="p">()]</span>
            <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">dist</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dist</span> <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">get_class</span><span class="p">()</span> <span class="o">!=</span> <span class="n">instance</span><span class="o">.</span><span class="n">get_class</span><span class="p">()]</span>
            <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span></div></div>


<span class="c1"># --- model-knn --- #</span>

<div class="viewcode-block" id="LOOClassNC"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.LOOClassNC">[docs]</a><span class="k">class</span> <span class="nc">LOOClassNC</span><span class="p">(</span><span class="n">NearestNeighbours</span><span class="p">,</span> <span class="n">ClassNC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    .. math::</span>
<span class="sd">        \\mathit{nc} = \\mathit{error} + (1 - p)</span>
<span class="sd">        \\quad \\text{or} \\quad</span>
<span class="sd">        \\mathit{nc} = \\frac{1 - p}{\\mathit{error}}</span>

<span class="sd">    :math:`p` ... probability of actual class predicted from :math:`N_k(z^*)` - k nearest neighbours</span>
<span class="sd">    of the instance :math:`z^*`</span>

<span class="sd">    The first nonconformity score is used when the parameter :py:attr:`relative` is set to *False*</span>
<span class="sd">    and the second one when it is set to *True*.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \\mathit{error} = \\frac {\\sum_{z_i \\in N_k(z^*)} w_i (1 - p_i)} {\\sum_{z_i \\in N_k(z^*)} w_i},</span>
<span class="sd">        \\quad w_i = \\frac{1}{d(x^*, x_i)}</span>

<span class="sd">    :math:`p_i` ... probability of actual class predicted from :math:`N_k(z&#39;) \\setminus z_i` or</span>
<span class="sd">    :math:`N_k(z&#39;) \\setminus z_i \\cup z^*` if the parameter :py:attr:`include` is set to *True*. :math:`z&#39;` is</span>
<span class="sd">    :math:`z^*` if the :py:attr:`neighbourhood` parameter is &#39;*fixed*&#39; and :math:`z_i` if it&#39;s &#39;*variable*&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="LOOClassNC.__init__"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.LOOClassNC.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">neighbourhood</span><span class="o">=</span><span class="s1">&#39;fixed&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the parameters.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">classifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relative</span> <span class="o">=</span> <span class="n">relative</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">include</span> <span class="o">=</span> <span class="n">include</span>
        <span class="k">assert</span> <span class="n">neighbourhood</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">,</span> <span class="s1">&#39;variable&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neighbourhood</span> <span class="o">=</span> <span class="n">neighbourhood</span></div>

<div class="viewcode-block" id="LOOClassNC.fit"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.LOOClassNC.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Store the data for finding nearest neighbours and initialize cache.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="LOOClassNC.get_neighbourhood"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.LOOClassNC.get_neighbourhood">[docs]</a>    <span class="k">def</span> <span class="nf">get_neighbourhood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct an Orange data Table consisting of instance&#39;s k nearest neighbours.</span>
<span class="sd">        Cache the results for later calls with the same instance.&quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="n">neigh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span><span class="p">(</span><span class="n">inst</span><span class="p">)[:</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">]</span>
            <span class="n">neigh_d</span><span class="p">,</span> <span class="n">neigh_list</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">neigh</span><span class="p">)</span>
            <span class="n">neigh_tab</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">neigh_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">neigh_list</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">neigh_tab</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">t</span><span class="p">]</span></div>

<div class="viewcode-block" id="LOOClassNC.error"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.LOOClassNC.error">[docs]</a>    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">neighbours</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the average weighted probability prediction error for predicting the actual class</span>
<span class="sd">        of each neighbour from the other ones. Include the new example among the neighbours</span>
<span class="sd">        if the parameter :py:attr:`include` is True.&quot;&quot;&quot;</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">)):</span>
            <span class="n">neigh</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="n">neighbours</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">neighbours</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">w</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">neigh</span><span class="p">)</span>
            <span class="n">ws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbourhood</span> <span class="o">==</span> <span class="s1">&#39;fixed&#39;</span><span class="p">:</span>
                <span class="n">neighbours_i</span> <span class="o">=</span> <span class="n">neighbours</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">))</span> <span class="o">!=</span> <span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">neighbours_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_neighbourhood</span><span class="p">(</span><span class="n">neigh</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include</span><span class="p">:</span>
                <span class="n">neighbours_i</span> <span class="o">=</span> <span class="n">neighbours_i</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">neighbours_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>

            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="p">(</span><span class="n">neighbours_i</span><span class="p">)</span>
            <span class="n">sc</span> <span class="o">+=</span> <span class="n">w</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">model</span><span class="p">(</span><span class="n">neigh</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="n">Model</span><span class="o">.</span><span class="n">Probs</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">neigh</span><span class="o">.</span><span class="n">get_class</span><span class="p">())])</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">sc</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ws</span><span class="p">))</span></div>

<div class="viewcode-block" id="LOOClassNC.nonconformity"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.LOOClassNC.nonconformity">[docs]</a>    <span class="k">def</span> <span class="nf">nonconformity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">):</span>
        <span class="n">neighbours</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_neighbourhood</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="p">(</span><span class="n">neighbours</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">neighbours</span><span class="p">)</span>
        <span class="n">yp</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="n">Model</span><span class="o">.</span><span class="n">Probs</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="n">get_class</span><span class="p">())]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">yp</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1e-6</span> <span class="o">+</span> <span class="n">error</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">error</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">yp</span><span class="p">)</span></div></div>


<span class="c1"># ----- REGRESSION ----- #</span>

<div class="viewcode-block" id="RegrNC"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.RegrNC">[docs]</a><span class="k">class</span> <span class="nc">RegrNC</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base class for regression nonconformity scores.</span>

<span class="sd">    Extending classes should implement :py:func:`fit`, :py:func:`nonconformity` and :py:func:`predict` methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RegrNC.fit"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.RegrNC.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process the data used for later calculation of nonconformities.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (Table): Data set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="RegrNC.nonconformity"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.RegrNC.nonconformity">[docs]</a>    <span class="k">def</span> <span class="nf">nonconformity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the nonconformity score of the given `instance`.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="RegrNC.predict"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.RegrNC.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">nc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the inverse of the nonconformity score. Determine a range of values for which the</span>
<span class="sd">        nonconformity of the given `instance` does not exceed `nc`.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>


<span class="c1"># --- model-based --- #</span>

<div class="viewcode-block" id="RegrModelNC"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.RegrModelNC">[docs]</a><span class="k">class</span> <span class="nc">RegrModelNC</span><span class="p">(</span><span class="n">RegrNC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for regression nonconformity scores that are based on an underlying classifier.</span>

<span class="sd">    Extending classes should implement :py:func:`RegrNC.nonconformity` and :py:func:`RegrNC.predict` methods.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        learner: Untrained underlying classifier.</span>
<span class="sd">        model: Trained underlying classifier.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RegrModelNC.__init__"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.RegrModelNC.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Store the provided classifier as :py:attr:`learner`.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learner</span> <span class="o">=</span> <span class="n">classifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">None</span></div>

<div class="viewcode-block" id="RegrModelNC.fit"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.RegrModelNC.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Train the underlying classifier on provided data and store the trained model.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learner</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="AbsError"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AbsError">[docs]</a><span class="k">class</span> <span class="nc">AbsError</span><span class="p">(</span><span class="n">RegrModelNC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Absolute error nonconformity score returns the absolute difference between</span>
<span class="sd">    the predicted value (:math:`\\hat{y}`) by the underlying :py:attr:`RegrModelNC.model`</span>
<span class="sd">    and the actual value (:math:`y^{*}`).</span>

<span class="sd">    .. math::</span>
<span class="sd">        \\mathit{nc} = |\\hat{y}-y^{*}|</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; train, test = next(LOOSampler(Table(&#39;housing&#39;)))</span>
<span class="sd">        &gt;&gt;&gt; cr = CrossRegressor(AbsError(LinearRegressionLearner()), 2, train)</span>
<span class="sd">        &gt;&gt;&gt; print(cr(test[0].x, 0.1))</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AbsError.nonconformity"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AbsError.nonconformity">[docs]</a>    <span class="k">def</span> <span class="nf">nonconformity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">get_class</span><span class="p">()</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">instance</span><span class="p">)))</span></div>

<div class="viewcode-block" id="AbsError.predict"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AbsError.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">nc</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">y</span><span class="o">-</span><span class="n">nc</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">nc</span></div></div>


<div class="viewcode-block" id="AbsErrorRF"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AbsErrorRF">[docs]</a><span class="k">class</span> <span class="nc">AbsErrorRF</span><span class="p">(</span><span class="n">RegrModelNC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;AbsErrorRF is based on an underlying regressor and a random forest. The prediction errors of regressor</span>
<span class="sd">    are used as nonconformity scores and are normalized by the standard deviation of predictions coming from</span>
<span class="sd">    individual trees in the forest.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \\mathit{nc} = \\frac{|\\hat{y}-y^{*}|}{\sigma_\\mathit{RF} + \\beta}</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from sklearn.ensemble import RandomForestRegressor</span>
<span class="sd">        &gt;&gt;&gt; icr = InductiveRegressor(AbsErrorRF(RandomForestRegressionLearner(), RandomForestRegressor()))</span>
<span class="sd">        &gt;&gt;&gt; r = run(icr, 0.1, CrossSampler(Table(&#39;housing&#39;), 10))</span>
<span class="sd">        &gt;&gt;&gt; print(r.accuracy(), r.median_range(), r.interdecile_mean())</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AbsErrorRF.__init__"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AbsErrorRF.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span> <span class="n">rf</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Store the classifier and beta parameter.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="n">RandomForestRegressor</span><span class="p">),</span> \
            <span class="s2">&quot;Second parameter must be an instance of sklearn&#39;s RandomForestRegressor.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learner</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">classifier</span><span class="p">,</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf</span> <span class="o">=</span> <span class="n">rf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span></div>

<div class="viewcode-block" id="AbsErrorRF.fit"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AbsErrorRF.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Train the underlying classifier on provided data and store the trained model.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learner</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbsErrorRF.norm"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AbsErrorRF.norm">[docs]</a>    <span class="k">def</span> <span class="nf">norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Normalization factor is equal to the standard deviation of predictions from trees in a random forest</span>
<span class="sd">        plus a constant term :py:attr:`beta`.&quot;&quot;&quot;</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="p">[</span><span class="n">estimator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="n">x</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">estimator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="o">.</span><span class="n">estimators_</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span></div>

<div class="viewcode-block" id="AbsErrorRF.nonconformity"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AbsErrorRF.nonconformity">[docs]</a>    <span class="k">def</span> <span class="nf">nonconformity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span>
        <span class="n">nc</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="n">get_class</span><span class="p">()</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nc</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbsErrorRF.predict"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AbsErrorRF.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">nc</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span> <span class="o">-</span> <span class="n">nc</span><span class="o">*</span><span class="n">norm</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">nc</span><span class="o">*</span><span class="n">norm</span></div></div>


<div class="viewcode-block" id="ErrorModelNC"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.ErrorModelNC">[docs]</a><span class="k">class</span> <span class="nc">ErrorModelNC</span><span class="p">(</span><span class="n">RegrModelNC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;ErrorModelNC is based on two underlying regressors. The first one is trained to predict the value while the</span>
<span class="sd">    second one is used for predicting logarithms of the errors made by the first one.</span>

<span class="sd">    H. Papadopoulos and H. Haralambous. *Reliable prediction intervals with regression neural networks*.</span>
<span class="sd">    Neural Networks (2011).</span>

<span class="sd">    .. math::</span>
<span class="sd">        \\mathit{nc} = \\frac{|\\hat{y}-y^{*}|}{\\exp(\\mu)-1 + \\beta}</span>

<span class="sd">    :math:`\\mu` ... prediction for the value of :math:`\\log(|\\hat{y}-y^{*}|+1)` returned by the second regressor</span>

<span class="sd">    Parameter :py:attr:`loo` determines whether to use a leave-one-out schema for building the training set</span>
<span class="sd">    of errors for the second regressor or not.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; nc = ErrorModelNC(SVRLearner(), LinearRegressionLearner())</span>
<span class="sd">        &gt;&gt;&gt; icr = InductiveRegressor(nc)</span>
<span class="sd">        &gt;&gt;&gt; r = run(icr, 0.1, CrossSampler(Table(&#39;housing&#39;), 10))</span>
<span class="sd">        &gt;&gt;&gt; print(r.accuracy(), r.median_range(), r.interdecile_mean())</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ErrorModelNC.__init__"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.ErrorModelNC.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span> <span class="n">error_classifier</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">loo</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">classifier</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_learner</span> <span class="o">=</span> <span class="n">error_classifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_model</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loo</span> <span class="o">=</span> <span class="n">loo</span></div>

<div class="viewcode-block" id="ErrorModelNC.fit"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.ErrorModelNC.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loo</span><span class="p">:</span>
            <span class="n">ys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
                <span class="n">train</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">!=</span> <span class="n">i</span><span class="p">]</span>
                <span class="n">inst</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learner</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
                <span class="n">ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="n">get_class</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learner</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learner</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">ys</span> <span class="o">=</span> <span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get_class</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">row</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
            <span class="n">error_data</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span>
        <span class="n">error_data</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_learner</span><span class="p">(</span><span class="n">error_data</span><span class="p">)</span></div>

<div class="viewcode-block" id="ErrorModelNC.nonconformity"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.ErrorModelNC.nonconformity">[docs]</a>    <span class="k">def</span> <span class="nf">nonconformity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">):</span>
        <span class="n">nc</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="n">get_class</span><span class="p">()</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">inst</span><span class="p">)))</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_model</span><span class="p">(</span><span class="n">inst</span><span class="p">)))</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span>
        <span class="k">return</span> <span class="n">nc</span> <span class="o">/</span> <span class="n">norm</span></div>

<div class="viewcode-block" id="ErrorModelNC.predict"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.ErrorModelNC.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">nc</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_model</span><span class="p">(</span><span class="n">inst</span><span class="p">)))</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span>
        <span class="k">return</span> <span class="n">y</span> <span class="o">-</span> <span class="n">nc</span><span class="o">*</span><span class="n">norm</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">nc</span><span class="o">*</span><span class="n">norm</span></div></div>


<div class="viewcode-block" id="ExperimentalNC"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.ExperimentalNC">[docs]</a><span class="k">class</span> <span class="nc">ExperimentalNC</span><span class="p">(</span><span class="n">RegrModelNC</span><span class="p">):</span>
<div class="viewcode-block" id="ExperimentalNC.__init__"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.ExperimentalNC.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rf</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf</span> <span class="o">=</span> <span class="n">rf</span></div>

<div class="viewcode-block" id="ExperimentalNC.fit"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.ExperimentalNC.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span><span class="o">//</span><span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ir</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">-</span> <span class="n">ys</span><span class="p">[</span><span class="n">d</span><span class="p">]</span></div>

<div class="viewcode-block" id="ExperimentalNC.norm"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.ExperimentalNC.norm">[docs]</a>    <span class="k">def</span> <span class="nf">norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">):</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="p">[</span><span class="n">estimator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="n">x</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">estimator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="o">.</span><span class="n">estimators_</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ir</span></div>

<div class="viewcode-block" id="ExperimentalNC.nonconformity"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.ExperimentalNC.nonconformity">[docs]</a>    <span class="k">def</span> <span class="nf">nonconformity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="n">x</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="n">get_class</span><span class="p">()</span> <span class="o">-</span> <span class="n">y</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span></div>

<div class="viewcode-block" id="ExperimentalNC.predict"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.ExperimentalNC.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">nc</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="n">x</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">nc</span><span class="p">)</span><span class="o">*</span><span class="n">norm</span><span class="p">,</span> <span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="n">nc</span><span class="p">)</span><span class="o">*</span><span class="n">norm</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span></div></div>


<span class="c1"># --- model-knn --- #</span>

<div class="viewcode-block" id="AbsErrorNormalized"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AbsErrorNormalized">[docs]</a><span class="k">class</span> <span class="nc">AbsErrorNormalized</span><span class="p">(</span><span class="n">RegrModelNC</span><span class="p">,</span> <span class="n">NearestNeighbours</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Normalized absolute error prediction uses an underlying regression model to predict the value,</span>
<span class="sd">    which is then normalized by the distance and variance of the nearest neighbours.</span>

<span class="sd">    H. Papadopoulos, V. Vovk and A. Gammerman. *Regression Conformal Prediction with Nearest Neighbours*.</span>
<span class="sd">    Journal of Artificial Intelligence Research (2011).</span>

<span class="sd">    .. math::</span>
<span class="sd">        \\mathit{nc} = \\frac{|\\hat{y}-y^{*}|}{\\exp(\\gamma \\lambda^*) + \exp(\\rho \\xi^*)}</span>
<span class="sd">        \\quad \\text{or} \\quad</span>
<span class="sd">        \\mathit{nc} = \\frac{|\\hat{y}-y^{*}|}{\\gamma + \\lambda^* + \\xi^*}</span>

<span class="sd">    The first nonconformity score is used when the parameter :py:attr:`exp` is set to *True*</span>
<span class="sd">    and the second one when it is set to *False*.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \\lambda^* = \\frac{d_k(z^*)}{\\mathit{median}(\\{d_k(z), z \\in T\\})}, \\quad</span>
<span class="sd">        d_k(z) = \\sum_{z_i \\in N_k(z)} distance(x, x_i)</span>

<span class="sd">    .. math::</span>
<span class="sd">        \\xi^* = \\frac{\\sigma_k(z^*)}{\\mathit{median}(\\{\\sigma_k(z), z \\in T\\})}, \\quad</span>
<span class="sd">        \\sigma_k(z) = \\sqrt{\\frac{1}{k} \\sum_{z_i \\in N_k(z)}(y_i-\\bar{y})}</span>

<span class="sd">    Parameter :py:attr:`rf` enables the use of a random forest for computing the standard deviation</span>
<span class="sd">    of predictions instead of the nearest neighbours.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AbsErrorNormalized.__init__"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AbsErrorNormalized.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">exp</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the parameters.&quot;&quot;&quot;</span>
        <span class="n">RegrModelNC</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classifier</span><span class="p">)</span>
        <span class="n">NearestNeighbours</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gamma</span> <span class="o">=</span> <span class="n">gamma</span>  <span class="c1"># distance sensitivity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rho</span> <span class="o">=</span> <span class="n">rho</span>  <span class="c1"># variance sensitivity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exp</span> <span class="o">=</span> <span class="n">exp</span>  <span class="c1"># type of normalization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf</span> <span class="o">=</span> <span class="n">rf</span>  <span class="c1"># random forest for normalization</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="n">RandomForestRegressor</span><span class="p">),</span> \
                <span class="s2">&quot;Rf must be an instance of sklearn&#39;s RandomForestRegressor.&quot;</span></div>

<div class="viewcode-block" id="AbsErrorNormalized.fit"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AbsErrorNormalized.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Train the underlying model and precompute medians for nonconformity scores.&quot;&quot;&quot;</span>
        <span class="n">RegrModelNC</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">NearestNeighbours</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span>
        <span class="c1"># compute medians in the training set used for normalization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">median_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span> <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">median_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_sigma</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span> <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">])</span></div>

<div class="viewcode-block" id="AbsErrorNormalized._d"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AbsErrorNormalized._d">[docs]</a>    <span class="k">def</span> <span class="nf">_d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sum of distances to nearest neighbours.&quot;&quot;&quot;</span>
        <span class="n">neigh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span><span class="p">(</span><span class="n">inst</span><span class="p">)[:</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">dist</span> <span class="k">for</span> <span class="n">dist</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">neigh</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbsErrorNormalized._lambda"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AbsErrorNormalized._lambda">[docs]</a>    <span class="k">def</span> <span class="nf">_lambda</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Normalized distance measure.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">median_d</span></div>

<div class="viewcode-block" id="AbsErrorNormalized._sigma"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AbsErrorNormalized._sigma">[docs]</a>    <span class="k">def</span> <span class="nf">_sigma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Standard deviation of y values. This comes either from the nearest neighbours or from the</span>
<span class="sd">        predictions of individual trees in a random forest if the :py:attr:`rf` is provided.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">:</span>
            <span class="n">neigh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span><span class="p">(</span><span class="n">inst</span><span class="p">)[:</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">([</span><span class="n">row</span><span class="o">.</span><span class="n">get_class</span><span class="p">()</span> <span class="k">for</span> <span class="n">dist</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">neigh</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="p">[</span><span class="n">estimator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="n">x</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">estimator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="o">.</span><span class="n">estimators_</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbsErrorNormalized._xi"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AbsErrorNormalized._xi">[docs]</a>    <span class="k">def</span> <span class="nf">_xi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Normalized variance measure.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigma</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">median_s</span></div>

<div class="viewcode-block" id="AbsErrorNormalized.norm"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AbsErrorNormalized.norm">[docs]</a>    <span class="k">def</span> <span class="nf">norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the normalization factor.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gamma</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_lambda</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rho</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_xi</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gamma</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lambda</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xi</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbsErrorNormalized.nonconformity"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AbsErrorNormalized.nonconformity">[docs]</a>    <span class="k">def</span> <span class="nf">nonconformity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">):</span>
        <span class="n">yp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="n">get_class</span><span class="p">()</span> <span class="o">-</span> <span class="n">yp</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbsErrorNormalized.predict"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AbsErrorNormalized.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">nc</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span><span class="o">-</span><span class="n">nc</span><span class="o">*</span><span class="n">norm</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">nc</span><span class="o">*</span><span class="n">norm</span></div></div>


<div class="viewcode-block" id="LOORegrNC"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.LOORegrNC">[docs]</a><span class="k">class</span> <span class="nc">LOORegrNC</span><span class="p">(</span><span class="n">NearestNeighbours</span><span class="p">,</span> <span class="n">RegrNC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    .. math::</span>
<span class="sd">        \\mathit{nc} = \\mathit{error} + |\\hat{y}-y^{*}|</span>
<span class="sd">        \\quad \\text{or} \\quad</span>
<span class="sd">        \\mathit{nc} = \\frac{|\\hat{y}-y^{*}|}{\\mathit{error}}</span>

<span class="sd">    :math:`\\hat{y}` ... value predicted from :math:`N_k(z^*)`</span>

<span class="sd">    The first nonconformity score is used when the parameter :py:attr:`relative` is set to *False*</span>
<span class="sd">    and the second one when it is set to *True*.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \\mathit{error} = \\frac {\\sum_{z_i \\in N_k(z^*)} w_i |\\hat{y_i}-y_i|} {\\sum_{z_i \\in N_k(z^*)} w_i},</span>
<span class="sd">        \\quad w_i = \\frac{1}{d(x^*, x_i)}</span>

<span class="sd">    :math:`\\hat{y_i}` ... value predicted from :math:`N_k(z&#39;) \\setminus z_i` or</span>
<span class="sd">    :math:`N_k(z&#39;) \\setminus z_i \\cup z^*` if the parameter :py:attr:`include` is set to *True*. :math:`z&#39;` is</span>
<span class="sd">    :math:`z^*` if the :py:attr:`neighbourhood` parameter is &#39;*fixed*&#39; and :math:`z_i` if it&#39;s &#39;*variable*&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="LOORegrNC.__init__"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.LOORegrNC.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">neighbourhood</span><span class="o">=</span><span class="s1">&#39;fixed&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the parameters.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">classifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relative</span> <span class="o">=</span> <span class="n">relative</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">include</span> <span class="o">=</span> <span class="n">include</span>
        <span class="k">assert</span> <span class="n">neighbourhood</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">,</span> <span class="s1">&#39;variable&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neighbourhood</span> <span class="o">=</span> <span class="n">neighbourhood</span></div>

<div class="viewcode-block" id="LOORegrNC.fit"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.LOORegrNC.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Store the data for finding nearest neighbours and initialize cache.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="LOORegrNC.get_neighbourhood"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.LOORegrNC.get_neighbourhood">[docs]</a>    <span class="k">def</span> <span class="nf">get_neighbourhood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct an Orange data Table consisting of instance&#39;s k nearest neighbours.</span>
<span class="sd">        Cache the results for later calls with the same instance.&quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="n">neigh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span><span class="p">(</span><span class="n">inst</span><span class="p">)[:</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">]</span>
            <span class="n">neigh_d</span><span class="p">,</span> <span class="n">neigh_list</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">neigh</span><span class="p">)</span>
            <span class="n">neigh_tab</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">neigh_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">neigh_list</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">neigh_tab</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">t</span><span class="p">]</span></div>

<div class="viewcode-block" id="LOORegrNC.error"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.LOORegrNC.error">[docs]</a>    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">neighbours</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the average weighted error for predicting the value of each neighbour from the other ones.</span>
<span class="sd">        Include the new example among the neighbours if the parameter :py:attr:`include` is True.&quot;&quot;&quot;</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">)):</span>
            <span class="n">neigh</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="n">neighbours</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">neighbours</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">w</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">neigh</span><span class="p">)</span>
            <span class="n">ws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbourhood</span> <span class="o">==</span> <span class="s1">&#39;fixed&#39;</span><span class="p">:</span>
                <span class="n">neighbours_i</span> <span class="o">=</span> <span class="n">neighbours</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">))</span> <span class="o">!=</span> <span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">neighbours_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_neighbourhood</span><span class="p">(</span><span class="n">neigh</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include</span><span class="p">:</span>
                <span class="n">neighbours_i</span> <span class="o">=</span> <span class="n">neighbours_i</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">neighbours_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>

            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="p">(</span><span class="n">neighbours_i</span><span class="p">)</span>
            <span class="n">sc</span> <span class="o">+=</span> <span class="n">w</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">neigh</span><span class="p">)</span> <span class="o">-</span> <span class="n">neigh</span><span class="o">.</span><span class="n">get_class</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">sc</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ws</span><span class="p">))</span></div>

<div class="viewcode-block" id="LOORegrNC.nonconformity"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.LOORegrNC.nonconformity">[docs]</a>    <span class="k">def</span> <span class="nf">nonconformity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">):</span>
        <span class="n">neighbours</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_neighbourhood</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="p">(</span><span class="n">neighbours</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">neighbours</span><span class="p">)</span>
        <span class="n">yp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">yp</span> <span class="o">-</span> <span class="n">inst</span><span class="o">.</span><span class="n">get_class</span><span class="p">())</span> <span class="o">/</span> <span class="n">error</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">error</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">yp</span> <span class="o">-</span> <span class="n">inst</span><span class="o">.</span><span class="n">get_class</span><span class="p">())</span></div>

<div class="viewcode-block" id="LOORegrNC.predict"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.LOORegrNC.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">nc</span><span class="p">):</span>
        <span class="n">neighbours</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_neighbourhood</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="p">(</span><span class="n">neighbours</span><span class="p">)</span>
        <span class="n">yp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">set_class</span><span class="p">(</span><span class="n">yp</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">neighbours</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">yp</span> <span class="o">-</span> <span class="p">(</span><span class="n">nc</span><span class="o">*</span><span class="n">error</span><span class="p">),</span> <span class="n">yp</span> <span class="o">+</span> <span class="p">(</span><span class="n">nc</span><span class="o">*</span><span class="n">error</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">yp</span> <span class="o">-</span> <span class="p">(</span><span class="n">nc</span><span class="o">-</span><span class="n">error</span><span class="p">),</span> <span class="n">yp</span> <span class="o">+</span> <span class="p">(</span><span class="n">nc</span><span class="o">-</span><span class="n">error</span><span class="p">)</span></div></div>


<span class="c1"># --- knn-based --- #</span>

<div class="viewcode-block" id="RegrNearestNeighboursNC"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.RegrNearestNeighboursNC">[docs]</a><span class="k">class</span> <span class="nc">RegrNearestNeighboursNC</span><span class="p">(</span><span class="n">NearestNeighbours</span><span class="p">,</span> <span class="n">RegrNC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for nearest neighbours based regression nonconformity scores.&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="AbsErrorKNN"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AbsErrorKNN">[docs]</a><span class="k">class</span> <span class="nc">AbsErrorKNN</span><span class="p">(</span><span class="n">RegrNearestNeighboursNC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Absolute error of k nearest neighbours computes the average value of the k nearest neighbours and</span>
<span class="sd">    returns an absolute difference between this average (:math:`y_k`) and the actual value (:math:`y^{*}`).</span>

<span class="sd">    .. math::</span>
<span class="sd">        \\bar{y} &amp;= 1/k \sum_{N_k(x^{*})} y_i \\\\</span>
<span class="sd">        \\mathit{nc} &amp;= |\\bar{y} - y^{*}|</span>

<span class="sd">    Weighted version can normalize by average and/or variance.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \\mathit{nc} = \\frac{ |\\bar{y}-y^{*}| } { \\bar{y} \cdot y_{\\sigma} }</span>

<span class="sd">    Attributes:</span>
<span class="sd">        average (bool): Normalize by average.</span>
<span class="sd">        variance (bool): Normalize by variance.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; train, test = next(LOOSampler(Table(&#39;housing&#39;)))</span>
<span class="sd">        &gt;&gt;&gt; cr = CrossRegressor(AbsErrorKNN(Euclidean, 10, average=True), 2, train)</span>
<span class="sd">        &gt;&gt;&gt; print(cr(test[0].x, 0.1))</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AbsErrorKNN.__init__"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AbsErrorKNN.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">variance</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the distance measure, number of nearest neighbours to consider and</span>
<span class="sd">        whether to normalize by average and by variance.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">average</span> <span class="o">=</span> <span class="n">average</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variance</span> <span class="o">=</span> <span class="n">variance</span></div>

<div class="viewcode-block" id="AbsErrorKNN.stats"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AbsErrorKNN.stats">[docs]</a>    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes mean and standard deviation of values within the k nearest neighbours.&quot;&quot;&quot;</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="n">neigh</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">get_class</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dist</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">neigh</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">neigh</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbsErrorKNN.norm"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AbsErrorKNN.norm">[docs]</a>    <span class="k">def</span> <span class="nf">norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">avg</span><span class="p">,</span> <span class="n">std</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the normalization factor according to the chosen properties.&quot;&quot;&quot;</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">average</span><span class="p">:</span> <span class="n">norm</span> <span class="o">/=</span> <span class="n">avg</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">variance</span><span class="p">:</span> <span class="n">norm</span> <span class="o">/=</span> <span class="n">std</span>
        <span class="k">return</span> <span class="n">norm</span></div>

<div class="viewcode-block" id="AbsErrorKNN.nonconformity"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AbsErrorKNN.nonconformity">[docs]</a>    <span class="k">def</span> <span class="nf">nonconformity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="n">avg</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="n">nc</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">get_class</span><span class="p">()</span> <span class="o">-</span> <span class="n">avg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">avg</span><span class="p">,</span> <span class="n">std</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbsErrorKNN.predict"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AbsErrorKNN.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">nc</span><span class="p">):</span>
        <span class="n">avg</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">avg</span><span class="p">,</span> <span class="n">std</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">avg</span> <span class="o">-</span> <span class="n">nc</span><span class="o">/</span><span class="n">norm</span><span class="p">,</span> <span class="n">avg</span> <span class="o">+</span> <span class="n">nc</span><span class="o">/</span><span class="n">norm</span></div></div>


<div class="viewcode-block" id="AvgErrorKNN"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AvgErrorKNN">[docs]</a><span class="k">class</span> <span class="nc">AvgErrorKNN</span><span class="p">(</span><span class="n">RegrNearestNeighboursNC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Average error of k nearest neighbours computes the average absolute error of the actual value (:math:`y^{*}`)</span>
<span class="sd">    compared to the k nearest neighbours (:math:`y_i`).</span>

<span class="sd">    .. math::</span>
<span class="sd">        \\mathit{nc} = 1/k \sum_{N_k(x^{*})} |y^{*} - y_i|</span>

<span class="sd">    Note:</span>
<span class="sd">        There might be no suitable `y` values for the required significance level at the time of prediction.</span>
<span class="sd">        In such cases, the predicted range is [nan, nan].</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; train, test = next(LOOSampler(Table(&#39;housing&#39;)))</span>
<span class="sd">        &gt;&gt;&gt; cr = CrossRegressor(AvgErrorKNN(Euclidean, 10), 2, train)</span>
<span class="sd">        &gt;&gt;&gt; print(cr(test[0].x, 0.1))</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AvgErrorKNN.avg_abs"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AvgErrorKNN.avg_abs">[docs]</a>    <span class="k">def</span> <span class="nf">avg_abs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ys</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">yi</span><span class="p">)</span> <span class="k">for</span> <span class="n">yi</span> <span class="ow">in</span> <span class="n">ys</span><span class="p">])</span></div>

<div class="viewcode-block" id="AvgErrorKNN.avg_abs_inv"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AvgErrorKNN.avg_abs_inv">[docs]</a>    <span class="k">def</span> <span class="nf">avg_abs_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nc</span><span class="p">,</span> <span class="n">ys</span><span class="p">):</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_abs</span><span class="p">(</span><span class="n">ys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">nc</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="c1"># lower bound</span>
        <span class="k">while</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_abs</span><span class="p">(</span><span class="n">ys</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ys</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">nc</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span><span class="o">-</span><span class="n">i</span>
        <span class="n">lo</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">nc</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">avg_abs</span><span class="p">(</span><span class="n">ys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ys</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">i1</span><span class="o">-</span><span class="n">i2</span><span class="p">)</span>
        <span class="c1"># upper bound</span>
        <span class="k">while</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_abs</span><span class="p">(</span><span class="n">ys</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">ys</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">nc</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">hi</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">nc</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">avg_abs</span><span class="p">(</span><span class="n">ys</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">ys</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">j1</span><span class="o">-</span><span class="n">j2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span></div>

<div class="viewcode-block" id="AvgErrorKNN.nonconformity"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AvgErrorKNN.nonconformity">[docs]</a>    <span class="k">def</span> <span class="nf">nonconformity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span><span class="p">(</span><span class="n">instance</span><span class="p">)[:</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">]</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">get_class</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dist</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_abs</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">get_class</span><span class="p">(),</span> <span class="n">ys</span><span class="p">)</span></div>

<div class="viewcode-block" id="AvgErrorKNN.predict"><a class="viewcode-back" href="../../cp.nonconformity.html#cp.nonconformity.AvgErrorKNN.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">nc</span><span class="p">):</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbours</span><span class="p">(</span><span class="n">inst</span><span class="p">)[:</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">]</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">get_class</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dist</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_abs_inv</span><span class="p">(</span><span class="n">nc</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Biolab.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.8</a>
      
    </div>

    

    
  </body>
</html>